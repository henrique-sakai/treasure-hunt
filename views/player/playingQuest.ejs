<!DOCTYPE html>

<html>

    <head>
        <title>Geolocation</title>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
        <meta charset="utf-8">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <style>
            /* Always set the map height explicitly to define the size of the div
            * element that contains the map. */
            #map {
                height: 80%;
            }
            /* Optional: Makes the sample page fill the window. */
            html, body {
                height: 100%;
                margin: 100;
                padding: 0;
            }
        </style>
    </head>

    <body style="width:80%; margin:auto">
     
        <p></p>
        <h2 style="text-align: center"><%= quest.name %></h2>
        <p></p>
        <p style="text-align: center"><%= quest.clue_text %></p>

        <div id="map"></div>

        <script>
            // Note: This example requires that you consent to location sharing when
            // prompted by your browser. If you see the error "The Geolocation service
            // failed.", it means you probably did not give permission for the browser to
            // locate you.
            var map, infoWindow;
            var id, target, options;
            
            function initMap() {
                map = new google.maps.Map(document.getElementById('map'), {
                    center: {lat: -34.397, lng: 150.644},
                    zoom: 20
                });
                infoWindow = new google.maps.InfoWindow;
            
                // Try HTML5 geolocation
                if (navigator.geolocation) {
                    //gets initial position and sets the center of the map at this position
                    navigator.geolocation.getCurrentPosition(function(position) {
                        var pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        //places a info window on the users location
                        infoWindow.setPosition(pos);
                        text = 'Start point:\nLat: ' + pos.lat + '\n Long: ' + pos.lng;
                        infoWindow.setContent(text);
                        infoWindow.open(map);

                        /*var myMarker = new google.maps.Marker({
                            position: new google.maps.LatLng(pos.lat , pos.lng),
                            draggable: true
                        });*/
                        //infoWindow.open(marker)

                        map.setCenter(pos);
                        //myMarker.setMap(map);
                    }, function() {
                        handleLocationError(true, infoWindow, map.getCenter());
                    });
                    //keeps getting users location
                    navigator.geolocation.watchPosition(success, error, options);
                } else {
                    // Browser doesn't support Geolocation
                    handleLocationError(false, infoWindow, map.getCenter());
                }
            }

            function handleLocationError(browserHasGeolocation, infoWindow, pos) {
                infoWindow.setPositMaion(pos);
                infoWindow.setContent(browserHasGeolocation ?
                    'Error: The Geolocation service failed.' :
                    'Error: Your browser doesn\'t support geolocation.');
                infoWindow.open(map);
            }
            function success(position) {
                var pos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                let north = <%= quest.north %>;
                let south = <%= quest.south %>;
                let east = <%= quest.east %>;
                let west = <%= quest.west %>;

                if(pos.lng>west && pos.lng<east && pos.lat>south && pos.lat <north){
                    infoWindow.setPosition(pos);
                    text = 'Sucesso';
                    infoWindow.setContent(text);
                    infoWindow.open(map);
                }
                else{
                    infoWindow.setPosition(pos);
                    text = 'Lat: ' + pos.lat + '\n Long: ' + pos.lng;
                    infoWindow.setContent(text);
                    infoWindow.open(map);
                }

                var myMarker = new google.maps.Marker({
                    position: new google.maps.LatLng(pos.lat , pos.lng),
                    draggable: true
                });
                //infoWindow.open(marker)

                map.setCenter(pos);
                myMarker.setMap(map);
                /*var crd = pos.coords;

                if (target.latitude === crd.latitude && target.longitude === crd.longitude) {
                    console.log('Congratulations, you reached the target');
                    navigator.geolocation.clearWatch(id);
                }*/
            }

            function error(err) {
                console.warn('ERROR(' + err.code + '): ' + err.message);
            }

            target = {
                latitude : 0,
                longitude: 0
            };

            options = {
                enableHighAccuracy: false,
                timeout: 5000,
                maximumAge: 0
            };

        </script>

        <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBV4PaT-tpXCdeGAW4e0mF_WAUC5GAMmBI&callback=initMap"></script>

    </body>

</html>